import { z } from "zod";

export const CallGraphResponse = z.object({ "root": z.object({ "id": z.string(), "name": z.string(), "kind": z.string(), "file_path": z.string(), "range_start": z.object({ "line": z.number().int(), "character": z.number().int() }) }), "nodes": z.record(z.object({ "id": z.string(), "name": z.string(), "kind": z.string(), "file_path": z.string(), "range_start": z.object({ "line": z.number().int(), "character": z.number().int() }) })), "edges_in": z.record(z.array(z.object({ "from_node_id": z.string(), "to_node_id": z.string(), "call_sites": z.array(z.object({ "line": z.number().int(), "character": z.number().int() })) }))), "edges_out": z.record(z.array(z.object({ "from_node_id": z.string(), "to_node_id": z.string(), "call_sites": z.array(z.object({ "line": z.number().int(), "character": z.number().int() })) }))), "direction": z.string(), "depth": z.number().int() });

export const CallGraphResponseTemplates = {
  "markdown": "\n### Call Graph for `{{ root.name }}` (Depth: {{ depth }}, Direction: {{ direction }})\n\n{%- macro render_tree(node_id, current_depth, visited, dir_label) %}\n  {%- if current_depth <= depth %}\n    {%- set node = nodes[node_id] %}\n    {%- set edges_to_show = edges_out[node_id] if dir_label == \"Calls\" else edges_in[node_id] %}\n{{ \"  \" * current_depth }}- **{{ node.name }}** (`{{ node.kind }}`) in `{{ node.file_path }}`\n    {%- if node_id in visited %} (recursive cycle)\n    {%- else %}\n      {%- do visited.append(node_id) %}\n      {%- for edge in edges_to_show %}\n        {%- set target_id = edge.to_node_id if dir_label == \"Calls\" else edge.from_node_id %}\n{{ render_tree(target_id, current_depth + 1, visited, dir_label) }}\n      {%- endfor %}\n    {%- endif %}\n  {%- endif %}\n{%- endmacro %}\n\n{% if direction in [\"incoming\", \"both\"] %}\n#### Incoming Calls (Who calls this?)\n{{ render_tree(root.id, 0, [], \"Called By\") }}\n{% endif %}\n\n{% if direction in [\"outgoing\", \"both\"] %}\n#### Outgoing Calls (What does this call?)\n{{ render_tree(root.id, 0, [], \"Calls\") }}\n{% endif %}\n\n---\n> [!NOTE]\n> Tree is truncated at depth {{ depth }}. Use `depth` parameter to explore further.\n"
} as const;
